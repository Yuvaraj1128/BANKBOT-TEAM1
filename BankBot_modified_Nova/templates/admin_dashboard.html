<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Manu Bank – Chat Admin</title>

    <!-- Font Awesome (icons) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      integrity="sha512-T2f3xXGxE+v3sYf0q0xQ6uWk7s1Kqk8F3kq7wqQ8+6JdGrx+fYVw8z1q2d2g9mXv1H6Lr3zK2zq3Z9zYc2h1w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      :root {
        /* Light + vibrant blue theme */
        --bg-page: #edf2ff;
        --bg-main: #f5f7ff;
        --bg-card: #ffffff;
        --bg-soft: #e0edff;

        --primary: #2563eb;      /* Bright blue */
        --primary-soft: #dbeafe; /* very light blue */
        --primary-dark: #1d4ed8;

        --accent: #0ea5e9;  /* cyan accent */
        --accent-soft: #e0f2fe;

        --text-main: #0f172a;
        --text-muted: #6b7280;
        --border: #d0d7f2;

        --success: #16a34a;
        --danger: #ef4444;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top left, #e0f2fe 0, #edf2ff 40%, #f9fafb 100%);
        color: var(--text-main);
      }

      /* Top bar */
      header.topbar {
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(
          90deg,
          #eff6ff 0%,
          #ffffff 45%,
          #e0f2fe 100%
        );
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand-logo {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: radial-gradient(circle at 25% 0, #38bdf8 0, #2563eb 35%, #1d4ed8 60%, #0f172a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #f9fafb;
        font-weight: 800;
        font-size: 20px;
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.25);
      }

      .brand-text h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.02em;
      }

      .brand-text span {
        display: block;
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .top-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .search-box {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #ffffff;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid #d4e0ff;
        box-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
      }

      .search-box input {
        border: none;
        outline: none;
        background: transparent;
        width: 220px;
        font-size: 13px;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: #dcfce7;
        border: 1px solid #bbf7d0;
        color: var(--success);
        font-weight: 600;
        font-size: 13px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--success);
      }

      /* Layout below header */
      .page {
        height: calc(100vh - 70px);
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 18px;
        padding: 16px 20px 20px;
        background: var(--bg-page);
      }

      /* Sidebar (left) */
      .sidebar {
        background: #f1f5ff;
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        box-shadow: 0 6px 20px rgba(148, 163, 184, 0.25);
      }

      .sidebar-section-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 6px;
      }

      .nav-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 9px 10px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        border: 1px solid transparent;
        color: var(--text-muted);
      }

      .nav-item i {
        width: 18px;
        text-align: center;
      }

      .nav-item.active {
        background: linear-gradient(90deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #93c5fd;
        color: #1e293b;
        box-shadow: 0 4px 16px rgba(129, 140, 248, 0.4);
        font-weight: 600;
      }

      .nav-item:hover:not(.active) {
        background: #e0edff;
      }

      .sidebar-card {
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 10px 12px;
      }

      .sidebar-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .sidebar-card-header span {
        font-size: 13px;
        font-weight: 600;
      }

      .sidebar-card small {
        font-size: 12px;
        color: var(--text-muted);
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 7px 14px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: linear-gradient(90deg, #2563eb, #38bdf8);
        color: #f9fafb;
        box-shadow: 0 4px 16px rgba(37, 99, 235, 0.45);
      }

      .btn-outline {
        background: #ffffff;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }

      .btn-outline:hover {
        background: #eff6ff;
      }

      .sidebar-footer {
        margin-top: auto;
        padding-top: 10px;
        border-top: 1px dashed #cbd5f5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .admin-meta {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .admin-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(135deg, #38bdf8, #6366f1);
      }

      .admin-text {
        font-size: 13px;
      }

      .admin-text div:first-child {
        font-weight: 600;
      }

      .admin-text div:last-child {
        color: var(--text-muted);
        font-size: 12px;
      }

      .logout-link {
        color: var(--danger);
        font-size: 14px;
        cursor: pointer;
      }

      /* Main content area */
      .main {
        background: var(--bg-main);
        border-radius: 18px;
        border: 1px solid var(--border);
        padding: 16px 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        box-shadow: 0 10px 25px rgba(148, 163, 184, 0.35);
      }

      .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 6px;
      }

      .main-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .main-header p {
        margin: 2px 0 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      .header-right {
        font-size: 13px;
        color: var(--text-muted);
      }

      /* Tab panels */
      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      /* Overview stats */
      .stats-row {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }

      .stat-card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px 12px 10px;
      }

      .stat-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
        letter-spacing: 0.08em;
      }

      .stat-value {
        font-size: 22px;
        font-weight: 700;
        margin-top: 4px;
      }

      .stat-sub {
        font-size: 12px;
        color: var(--primary-dark);
        margin-top: 4px;
      }

      /* grid below stats: left & right */
      .content-grid {
        display: grid;
        grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
        gap: 12px;
        margin-top: 10px;
      }

      .panel {
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 12px 12px 10px;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .panel-title {
        font-size: 15px;
        font-weight: 600;
      }

      .panel-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: var(--primary-soft);
      }

      th,
      td {
        padding: 8px 8px;
      }

      th {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
        letter-spacing: 0.08em;
        text-align: left;
        border-bottom: 1px solid #c7d2fe;
      }

      tbody tr:nth-child(odd) {
        background: #ffffff;
      }

      tbody tr:nth-child(even) {
        background: #f9fbff;
      }

      tbody tr:hover {
        background: #e0edff;
      }

      td {
        border-bottom: 1px solid #e5e7eb;
      }

      .text-muted {
        color: var(--text-muted);
      }

      /* Forms */
      form input,
      form textarea,
      form select {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 8px 10px;
        font-size: 13px;
        margin-bottom: 8px;
        background: #f9fafb;
      }

      form input:focus,
      form textarea:focus {
        outline: 2px solid #bfdbfe;
        background: #ffffff;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }

      .actions-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 4px;
      }

      /* Intent tag */
      .intent-tag {
        background: var(--accent-soft);
        color: var(--accent);
        padding: 3px 7px;
        border-radius: 999px;
        font-size: 11px;
        font-family: monospace;
        border: 1px solid #bae6fd;
      }

      /* Logs preview */
      .mini-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 230px;
        overflow-y: auto;
        margin-top: 4px;
      }

      .mini-item {
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 8px 10px;
        background: #f9fbff;
      }

      .mini-item-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        font-size: 12px;
      }

      .mini-item-body {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      /* Logs full table */
      .panel-scroll {
        overflow-x: auto;
        max-height: 420px;
      }

      /* RESPONSIVE */
      @media (max-width: 1024px) {
        .page {
          grid-template-columns: 1fr;
        }

        .content-grid {
          grid-template-columns: 1fr;
        }

        .stats-row {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 768px) {
        header.topbar {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          height: auto;
          padding: 10px 16px 12px;
        }

        .top-right {
          width: 100%;
          justify-content: space-between;
        }

        .page {
          padding: 10px;
        }

        .search-box input {
          width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <!-- TOP BAR -->
    <header class="topbar">
      <div class="brand">
        <div class="brand-logo">M</div>
        <div class="brand-text">
          <h1>Manu Bank</h1>
          <span>AI Chat Administration</span>
        </div>
      </div>

      <div class="top-right">
        <div class="search-box">
          <i class="fas fa-magnifying-glass" style="color: var(--text-muted)"></i>
          <input
            id="globalSearch"
            type="text"
            placeholder="Search user, intent, or log ID…"
          />
        </div>
        <div class="status-pill">
          <span class="status-dot"></span>
          System Operational
        </div>
      </div>
    </header>

    <!-- LAYOUT: SIDEBAR + MAIN -->
    <div class="page">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div>
          <div class="sidebar-section-title">Navigation</div>
          <div class="nav-list">
            <div
              class="nav-item active"
              onclick="switchTab(this, 'dashboard')"
            >
              <i class="fas fa-chart-line"></i>
              Overview
            </div>
            <div class="nav-item" onclick="switchTab(this, 'training')">
              <i class="fas fa-brain"></i>
              Neural Training
            </div>
            <div class="nav-item" onclick="switchTab(this, 'faqs')">
              <i class="fas fa-book-open"></i>
              Knowledge Base
            </div>
            <div class="nav-item" onclick="switchTab(this, 'logs')">
              <i class="fas fa-clipboard-list"></i>
              User Logs
            </div>
          </div>
        </div>

        <div class="sidebar-card">
          <div class="sidebar-card-header">
            <span>Model Status</span>
            <small>v2.0</small>
          </div>
          <small>Chat engine is ready for retraining.</small>
          <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 6px;">
            <button
              id="retrainBtnSidebar"
              class="btn btn-primary"
              onclick="retrainModel()"
              type="button"
            >
              <i class="fas fa-sync-alt"></i> Retrain
            </button>
            <small id="retrainStatusSidebar" style="color: var(--text-muted)">
              Last trained: Just now
            </small>
          </div>
        </div>

        <div class="sidebar-footer">
          <div class="admin-meta">
            <div class="admin-avatar"></div>
            <div class="admin-text">
              <div>Admin</div>
              <div>admin@manubank.ai</div>
            </div>
          </div>
          <div
            class="logout-link"
            onclick="location.href='/logout'"
            title="Sign out"
          >
            <i class="fas fa-sign-out-alt"></i>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main">
        <div class="main-header">
          <div>
            <h2 id="page-title">Dashboard Overview</h2>
            <p>Monitor chat activity, training data, and user logs.</p>
          </div>
          <div class="header-right">
            Live data from Manu Bank Chat Engine
          </div>
        </div>

        <!-- DASHBOARD PANEL -->
        <section id="dashboard" class="tab-panel active">
          <!-- Stats -->
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label">Total Queries</div>
              <div class="stat-value">{{ stats.total }}</div>
              <div class="stat-sub">
                <i class="fas fa-arrow-trend-up"></i> Live count
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Success Rate</div>
              <div class="stat-value">{{ stats.success_rate }}%</div>
              <div class="stat-sub">High confidence (&gt; 65%)</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Top Intent</div>
              <div class="stat-value" style="font-size: 18px;">
                {% if stats.top_intents %} {{ stats.top_intents[0][0] }} {% else
                %} N/A {% endif %}
              </div>
              <div class="stat-sub">Most frequent label</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Knowledge Base</div>
              <div class="stat-value">Active</div>
              <div class="stat-sub">Hybrid mode enabled</div>
            </div>
          </div>

          <div class="content-grid">
            <!-- LEFT COL: Recent & Training -->
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <!-- Recent Interactions -->
              <div class="panel">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Recent Live Interactions</div>
                    <div class="panel-subtitle">
                      Latest conversations handled by the bot.
                    </div>
                  </div>
                  <button
                    class="btn btn-outline"
                    type="button"
                    onclick="location.href='/admin/export_logs'"
                  >
                    <i class="fas fa-download"></i> Export CSV
                  </button>
                </div>
                <div style="max-height: 230px; overflow: auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>Account</th>
                        <th>User Query</th>
                        <th>Bot Response</th>
                        <th>Timestamp</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for acct, msg, resp, time in recent_queries %}
                      <tr>
                        <td>
                          <span
                            style="
                              font-family: monospace;
                              color: var(--primary-dark);
                            "
                            >{{ acct }}</span
                          >
                        </td>
                        <td>{{ msg }}</td>
                        <td class="text-muted">{{ resp[:50] }}...</td>
                        <td class="text-muted">{{ time }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Quick Add Training + List -->
              <div class="panel">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Quick Add Training Data</div>
                    <div class="panel-subtitle">
                      Add examples to improve intent accuracy.
                    </div>
                  </div>
                </div>

                <form id="trainForm" onsubmit="addTrainingData(event)">
                  <div class="form-row">
                    <input
                      type="text"
                      name="text"
                      placeholder="User says (e.g., 'I lost my platinum card')"
                      required
                    />
                    <input
                      type="text"
                      name="intent"
                      placeholder="Intent label (e.g., card_lost)"
                      required
                    />
                  </div>
                  <input
                    type="text"
                    name="response"
                    placeholder="Bot response (optional)"
                  />
                  <div class="actions-row">
                    <button class="btn btn-outline" type="button" onclick="loadTrainingData()">
                      <i class="fas fa-rotate-right"></i> Refresh
                    </button>
                    <button class="btn btn-primary" type="submit">
                      <i class="fas fa-plus-circle"></i> Add
                    </button>
                  </div>
                </form>

                <div style="margin-top: 8px;">
                  <div style="font-weight: 600; font-size: 14px;">
                    Existing Training Examples (Last 50)
                  </div>
                  <div style="max-height: 200px; overflow: auto; margin-top: 4px;">
                    <table id="trainingTable">
                      <thead>
                        <tr>
                          <th>User Text</th>
                          <th>Intent</th>
                          <th>Response</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- filled by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT COL: FAQ Form + Logs Preview -->
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <!-- FAQ Add -->
              <div class="panel">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Add FAQ to Knowledge Base</div>
                    <div class="panel-subtitle">
                      Answers here will be used for hybrid responses.
                    </div>
                  </div>
                </div>
                <form id="faqForm" onsubmit="addFaq(event)">
                  <input
                    type="text"
                    name="question"
                    placeholder="Question (e.g., 'What is the SWIFT code?')"
                    required
                  />
                  <textarea
                    name="answer"
                    rows="3"
                    placeholder="Answer to display..."
                    required
                  ></textarea>
                  <div class="actions-row">
                    <button
                      class="btn btn-outline"
                      type="button"
                      onclick="loadFaqs()"
                    >
                      Refresh list
                    </button>
                    <button class="btn btn-primary" type="submit">
                      <i class="fas fa-save"></i> Save
                    </button>
                  </div>
                </form>
              </div>

              <!-- Logs Preview -->
              <div class="panel">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">User Query Logs (Preview)</div>
                    <div class="panel-subtitle">
                      Snapshot of the latest activity.
                    </div>
                  </div>
                </div>
                <div class="mini-list" id="logsPreview">
                  <!-- filled by JS -->
                </div>
                <div class="actions-row" style="margin-top: 6px;">
                  <button
                    class="btn btn-outline"
                    type="button"
                    onclick="loadSystemLogs()"
                  >
                    <i class="fas fa-sync-alt"></i> Refresh
                  </button>
                  <button
                    class="btn btn-primary"
                    type="button"
                    onclick="location.href='/admin/export_logs'"
                  >
                    <i class="fas fa-file-export"></i> Export all
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- TRAINING TAB -->
        <section id="training" class="tab-panel">
          <div class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Neural Network Training</div>
                <div class="panel-subtitle">
                  Manage and retrain Manu Bank's chat model.
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button
                  id="retrainBtn"
                  class="btn btn-primary"
                  type="button"
                  onclick="retrainModel()"
                >
                  <i class="fas fa-sync-alt"></i> Retrain Model
                </button>
                <button
                  class="btn btn-outline"
                  type="button"
                  onclick="loadTrainingData()"
                >
                  Load Examples
                </button>
              </div>
            </div>

            <div style="margin-bottom: 8px;">
              <div style="font-size: 13px; color: var(--text-muted);">
                Status: <span style="font-weight: 600; color: var(--success);">Ready</span>
              </div>
              <div
                id="retrainStatus"
                style="font-size: 12px; color: var(--text-muted); margin-top: 2px;"
              >
                Last trained: Just now
              </div>
            </div>

            <div class="panel-scroll">
              <table id="trainingTableLarge">
                <thead>
                  <tr>
                    <th>User Text</th>
                    <th>Intent</th>
                    <th>Response</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- FAQ TAB -->
        <section id="faqs" class="tab-panel">
          <div class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Knowledge Base Management</div>
                <div class="panel-subtitle">
                  Review and maintain active FAQs.
                </div>
              </div>
              <button
                class="btn btn-outline"
                type="button"
                onclick="loadFaqs()"
              >
                <i class="fas fa-rotate-right"></i> Refresh
              </button>
            </div>

            <div class="panel-scroll">
              <table id="faqTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Question</th>
                    <th>Answer</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- LOGS TAB -->
        <section id="logs" class="tab-panel">
          <div class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">User Query Logs (Last 100)</div>
                <div class="panel-subtitle">
                  Full view of the latest interactions.
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button
                  class="btn btn-outline"
                  type="button"
                  onclick="loadSystemLogs()"
                >
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button
                  class="btn btn-primary"
                  type="button"
                  onclick="location.href='/admin/export_logs'"
                >
                  <i class="fas fa-file-csv"></i> Export CSV
                </button>
              </div>
            </div>

            <div class="panel-scroll">
              <table id="logsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Time</th>
                    <th>Account</th>
                    <th>User Message</th>
                    <th>Intent / Confidence</th>
                    <th>Response</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- SCRIPTS -->
    <script>
      /* TAB SWITCHING */
      function switchTab(el, tabId) {
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        if (el) el.classList.add("active");

        document
          .querySelectorAll(".tab-panel")
          .forEach((p) => p.classList.remove("active"));
        const panel = document.getElementById(tabId);
        if (panel) panel.classList.add("active");

        const titles = {
          dashboard: "Dashboard Overview",
          training: "Neural Network Training",
          faqs: "Knowledge Base Management",
          logs: "User Query Logs",
        };
        const pageTitle = document.getElementById("page-title");
        if (pageTitle && titles[tabId]) {
          pageTitle.innerText = titles[tabId];
        }
      }

      /* Escape HTML helper */
      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      /* TRAINING DATA LOAD */
      async function loadTrainingData() {
        try {
          const res = await fetch("/admin/training_data");
          const data = await res.json();

          const smallBody = document.querySelector("#trainingTable tbody");
          const largeBody = document.querySelector("#trainingTableLarge tbody");

          if (smallBody) smallBody.innerHTML = "";
          if (largeBody) largeBody.innerHTML = "";

          data.forEach((row) => {
            const text = row.text || row.User_Message || "";
            const intent = row.intent || row.Intent || "";
            const response = row.response || "";

            if (smallBody) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${escapeHtml(text).slice(0, 80)}</td>
                <td><span class="intent-tag">${escapeHtml(intent)}</span></td>
                <td class="text-muted">${escapeHtml(response)}</td>
              `;
              smallBody.appendChild(tr);
            }

            if (largeBody) {
              const tr2 = document.createElement("tr");
              tr2.innerHTML = `
                <td>${escapeHtml(text)}</td>
                <td><span class="intent-tag">${escapeHtml(intent)}</span></td>
                <td class="text-muted">${escapeHtml(response)}</td>
              `;
              largeBody.appendChild(tr2);
            }
          });
        } catch (err) {
          console.error("Error loading training data:", err);
          const smallBody = document.querySelector("#trainingTable tbody");
          if (smallBody) {
            smallBody.innerHTML =
              '<tr><td colspan="3" class="text-muted">Error loading data</td></tr>';
          }
        }
      }

      async function addTrainingData(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
          const res = await fetch("/admin/training_data", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.status === "success") {
            alert("Training data added successfully!");
            e.target.reset();
            loadTrainingData();
          } else {
            alert("Error: " + (data.msg || "Unknown error"));
          }
        } catch (err) {
          alert("Server error while adding training data.");
        }
      }

      /* RETRAIN MODEL */
      async function retrainModel() {
        const btn =
          document.getElementById("retrainBtn") ||
          document.getElementById("retrainBtnSidebar");
        const status =
          document.getElementById("retrainStatus") ||
          document.getElementById("retrainStatusSidebar");

        if (!btn) return;
        const previous = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training...';

        try {
          const res = await fetch("/admin/retrain", { method: "POST" });
          const data = await res.json();
          if (data.status === "success") {
            if (status) {
              status.innerHTML =
                '<span style="color: var(--success);">Training complete!</span>';
            }
            alert("Model retrained successfully.");
          } else {
            if (status) status.textContent = "Training failed";
            alert("Training failed.");
          }
        } catch (err) {
          if (status) status.textContent = "Server error";
          alert("Server error while retraining model.");
        } finally {
          btn.disabled = false;
          btn.innerHTML = previous;
        }
      }

      /* FAQ LOAD & ADD */
      async function loadFaqs() {
        try {
          const res = await fetch("/admin/faqs");
          const data = await res.json();
          const tbody = document.querySelector("#faqTable tbody");
          if (!tbody) return;
          tbody.innerHTML = "";
          data.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>#${row.id}</td>
              <td>${escapeHtml(row.question)}</td>
              <td class="text-muted">${escapeHtml(row.answer)}</td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Error loading FAQs:", err);
        }
      }

      async function addFaq(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
          const res = await fetch("/admin/faqs", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.status === "success") {
            alert("FAQ added to Knowledge Base!");
            e.target.reset();
            loadFaqs();
          } else {
            alert("Error adding FAQ.");
          }
        } catch (err) {
          alert("Server error while adding FAQ.");
        }
      }

      /* LOGS LOAD (preview + full table) */
      async function loadSystemLogs() {
        try {
          const res = await fetch("/admin/logs_json");
          const data = await res.json();

          // Preview list
          const preview = document.getElementById("logsPreview");
          if (preview) {
            preview.innerHTML = "";
            const previewItems = Array.isArray(data)
              ? data.slice(0, 8)
              : [];
            if (previewItems.length === 0) {
              preview.innerHTML =
                '<div class="mini-item mini-item-body">No logs found.</div>';
            } else {
              previewItems.forEach((row) => {
                const conf = (row.confidence || 0) * 100;
                let confColor = "var(--text-muted)";
                if (conf > 80) confColor = "var(--success)";
                else if (conf < 50) confColor = "var(--danger)";

                const item = document.createElement("div");
                item.className = "mini-item";
                item.innerHTML = `
                  <div class="mini-item-header">
                    <div>
                      <strong>${escapeHtml(row.account || "Guest")}</strong>
                      <span class="text-muted"> · ${escapeHtml(
                        row.timestamp || ""
                      )}</span>
                    </div>
                    <div style="font-size:11px;color:${confColor};font-weight:600;">
                      ${Math.round(conf)}%
                    </div>
                  </div>
                  <div class="mini-item-body">
                    ${escapeHtml((row.user_message || "").slice(0, 100))}
                  </div>
                `;
                preview.appendChild(item);
              });
            }
          }

          // Full table
          const logsTbody = document.querySelector("#logsTable tbody");
          if (logsTbody) {
            logsTbody.innerHTML = "";
            if (!Array.isArray(data) || data.length === 0) {
              logsTbody.innerHTML =
                '<tr><td colspan="6" class="text-muted">No logs found.</td></tr>';
            } else {
              data.forEach((row) => {
                const conf = (row.confidence || 0) * 100;
                let confColor = "var(--text-muted)";
                if (conf > 80) confColor = "var(--success)";
                else if (conf < 50) confColor = "var(--danger)";

                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td class="text-muted">#${row.id}</td>
                  <td class="text-muted">${escapeHtml(row.timestamp || "")}</td>
                  <td><span style="font-family: monospace; color: var(--primary-dark);">${escapeHtml(row.account || "Guest")}</span></td>
                  <td style="max-width: 240px; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(row.user_message || "")}
                  </td>
                  <td>
                    <span class="intent-tag">${escapeHtml(
                      row.predicted_intent || "N/A"
                    )}</span>
                    <span
                      style="font-size: 11px; font-weight: 600; margin-left: 4px; color: ${confColor};"
                    >
                      ${Math.round(conf)}%
                    </span>
                  </td>
                  <td class="text-muted">
                    ${escapeHtml((row.bot_response || "").substring(0, 60))}...
                  </td>
                `;
                logsTbody.appendChild(tr);
              });
            }
          }
        } catch (err) {
          console.error("Error loading logs:", err);
          const logsTbody = document.querySelector("#logsTable tbody");
          if (logsTbody) {
            logsTbody.innerHTML =
              '<tr><td colspan="6" class="text-muted">Error loading logs</td></tr>';
          }
        }
      }

      /* GLOBAL SEARCH (simple filter on logs preview) */
      document
        .getElementById("globalSearch")
        .addEventListener("keydown", async function (e) {
          if (e.key !== "Enter") return;
          const query = this.value.trim().toLowerCase();
          if (!query) {
            loadSystemLogs();
            return;
          }
          try {
            const res = await fetch("/admin/logs_json");
            const data = await res.json();
            const filtered = (data || []).filter((row) => {
              return (
                String(row.id || "").includes(query) ||
                (row.account || "").toLowerCase().includes(query) ||
                (row.user_message || "").toLowerCase().includes(query) ||
                (row.predicted_intent || "").toLowerCase().includes(query)
              );
            });
            const preview = document.getElementById("logsPreview");
            if (preview) {
              preview.innerHTML = "";
              if (filtered.length === 0) {
                preview.innerHTML =
                  '<div class="mini-item mini-item-body">No matching logs.</div>';
              } else {
                filtered.slice(0, 8).forEach((row) => {
                  const item = document.createElement("div");
                  item.className = "mini-item";
                  item.innerHTML = `
                    <div class="mini-item-header">
                      <div>
                        <strong>${escapeHtml(row.account || "Guest")}</strong>
                        <span class="text-muted"> · ${escapeHtml(
                          row.timestamp || ""
                        )}</span>
                      </div>
                    </div>
                    <div class="mini-item-body">
                      ${escapeHtml((row.user_message || "").slice(0, 100))}
                    </div>
                  `;
                  preview.appendChild(item);
                });
              }
            }
          } catch (err) {
            console.error("Search error:", err);
          }
        });

      /* INITIAL LOAD */
      (function init() {
        loadTrainingData();
        loadFaqs();
        loadSystemLogs();
      })();
    </script>
  </body>
</html>
