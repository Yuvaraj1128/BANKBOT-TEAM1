<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manu Bank â€” Virtual Assistant</title>

  <style>
    :root{
      --bg: #f6fbff;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #052033;
      --accent: #0ea5e9;
      --radius: 12px;
    }

    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    body{margin:0;background:var(--bg);color:var(--text);padding:18px;display:flex;flex-direction:column;min-height:100vh;}
    .wrap{max-width:780px;margin:0 auto;width:100%;display:flex;flex-direction:column;gap:14px;}

    h2{font-size:20px;margin:0 0 6px;}

    /* Chat card */
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:0 8px 26px rgba(14,165,233,0.06);border:1px solid #e6f4ff;overflow:hidden;display:flex;flex-direction:column;}
    .chat-window{height:60vh;min-height:320px;max-height:68vh;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,rgba(14,165,233,0.02),transparent);}

    .msg {max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.4;word-break:break-word;}
    .msg .meta {display:block;font-size:11px;color:var(--muted);margin-top:6px}
    .msg.user{align-self:flex-end;background:var(--accent);color:#fff;border-radius:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(14,165,233,0.08)}
    .msg.bot{align-self:flex-start;background:#eef9ff;color:var(--text);border:1px solid rgba(5,32,51,0.04)}

    .chat-form{display:flex;gap:10px;padding:12px;border-top:1px solid #e6f4ff;background:var(--panel)}
    .chat-form input[type="text"]{flex:1;padding:12px 14px;border-radius:999px;border:1px solid #e6f4ff;font-size:14px;outline:none}
    .chat-form input[type="text"]:focus{box-shadow:0 6px 18px rgba(14,165,233,0.06);border-color:var(--accent)}
    .chat-form button{padding:10px 16px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--accent),#2563eb);color:#fff;font-weight:700;cursor:pointer}
    .chat-form button[disabled]{opacity:.6;cursor:default}

    .small{font-size:13px;color:var(--muted)}
    .center{display:flex;justify-content:center;align-items:center}

    /* timestamp */
    .time {font-size:11px;color:var(--muted);margin-top:6px}

    @media (max-width:640px){
      .chat-window{height:52vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>MANU Bank Virtual Assistant ðŸ’¬</h2>

    <div class="card" role="region" aria-label="Chat with bank assistant">
      <div id="chatWindow" class="chat-window" aria-live="polite">
        <!-- initial bot greeting -->
        <div class="msg bot">
          Hello! I'm your assistant â€” how can I help you today?
          <span class="meta">Just now</span>
        </div>
      </div>

      <form id="chatForm" class="chat-form" autocomplete="off">
        <input id="userInput" type="text" name="msg" placeholder="Type your message..." aria-label="Type your message" required />
        <button id="sendBtn" type="submit">Send</button>
      </form>
    </div>

    <div class="center small">
      <div>Tip: Press Enter to send â€¢ Responses come from <code>/get</code></div>
    </div>
  </div>

  <script>
    // Helper: escape HTML to avoid injection when inserting messages
    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function now() {
      const d = new Date();
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    const chatWindow = document.getElementById('chatWindow');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // Append message to chat window
    function appendMessage({ who = 'bot', text = '', ts = '' }) {
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      // preserve newlines
      const safeHtml = escapeHtml(text).replace(/\\n/g, '<br>');
      div.innerHTML = safeHtml + (ts ? `<span class="meta">${ts}</span>` : '');
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Small helper to show typing indicator
    function showTyping() {
      const t = document.createElement('div');
      t.className = 'msg bot typing';
      t.id = 'typingIndicator';
      t.textContent = 'Typingâ€¦';
      chatWindow.appendChild(t);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    function removeTyping() {
      const t = document.getElementById('typingIndicator');
      if (t) t.remove();
    }

    async function postMessageToServer(message) {
      // keep same content type as original: application/x-www-form-urlencoded
      const body = `msg=${encodeURIComponent(message)}`;
      const res = await fetch('/get', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!res.ok) throw new Error('Network response was not ok');
      return res.json();
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = userInput.value.trim();
      if (!text) return;
      // show user message immediately
      appendMessage({ who: 'user', text, ts: now() });
      userInput.value = '';
      userInput.focus();

      // show typing indicator
      showTyping();
      sendBtn.disabled = true;

      try {
        const json = await postMessageToServer(text);
        removeTyping();
        sendBtn.disabled = false;

        // server expected to return JSON with { response: "string" }
        const reply = (json && (json.response || json.reply || json.bot)) ? (json.response || json.reply || json.bot) : "Sorry â€” no reply.";
        appendMessage({ who: 'bot', text: reply, ts: now() });
      } catch (err) {
        removeTyping();
        sendBtn.disabled = false;
        appendMessage({ who: 'bot', text: 'âš ï¸ Connection error. Please try again later.', ts: now() });
        console.error(err);
      }
    });

    // UX: allow Enter to send, Shift+Enter for newline
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.requestSubmit();
      }
    });
  </script>
</body>
</html>
